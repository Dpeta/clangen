name: PyInstaller build

on: [push]

jobs:
  build_linux64:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python 3.11 x64
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: 'x64'
      - name: Update pip
        run: python -m pip install --upgrade pip
      - name: Update setuptools
        run: python -m pip install --upgrade setuptools
      - name: Install dependencies
        run: python -m pip install -r requirements.txt
      - name: Install Pillow for icon format conversion
        run: python -m pip install --upgrade Pillow
      - name: Install PyInstaller
        run: python -m pip install --upgrade PyInstaller
      - name: Run PyInstaller
        #run: python -m PyInstaller -i resources/images/icon.png --name clangen --windowed --onedir --clean --add-data sprites:sprites --add-data resources:resources --add-data README.md:. main.py
        run: python -m PyInstaller Clangen.spec
      - name: Create archive (.tar.xz)
        run: tar -cavf Clangen_Linux64.tar.xz -C dist Clangen
      - uses: actions/upload-artifact@v3
        with:
          name: Clangen_Linux64.tar.xz
          path: Clangen_Linux64.tar.xz
      - name: Release 
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: Clangen_Linux64.tar.xz
          
  build_win32:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python 3.8 x86
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # 3.8 to support older versions of Windows
          architecture: 'x86'
      - name: Update pip
        run: python -m pip install --upgrade pip
      - name: Update setuptools
        run: python -m pip install --upgrade setuptools
      - name: Install dependencies
        run: python -m pip install -r requirements.txt
      - name: Install Pillow for icon format conversion
        run: python -m pip install --upgrade Pillow
      - name: Install PyInstaller
        run: python -m pip install --upgrade PyInstaller
      - name: Run PyInstaller
        #run: python -m PyInstaller -i resources/images/icon.png --name clangen --windowed --noupx --onedir --clean --add-data "sprites;sprites" --add-data "resources;resources" --add-data "README.md;." main.py
        run: python -m PyInstaller Clangen.spec
      - name: Create archive (.zip)
        run: tar.exe -a -c -f Clangen_Win32.zip -C dist Clangen
      - uses: actions/upload-artifact@v3
        with:
          name: Clangen_Win32.zip
          path: Clangen_Win32.zip
      - name: Release 
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: Clangen_Win32.zip    
          
  build_win64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python 3.11 x64
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # 3.8 to support older versions of Windows
          architecture: 'x64'
      - name: Update pip
        run: python -m pip install --upgrade pip
      - name: Update setuptools
        run: python -m pip install --upgrade setuptools
      - name: Install dependencies
        run: python -m pip install -r requirements.txt
      - name: Install Pillow for icon format conversion
        run: python -m pip install --upgrade Pillow
      - name: Install PyInstaller
        run: python -m pip install --upgrade PyInstaller
      - name: Run PyInstaller
        #run: python -m PyInstaller -i resources/images/icon.png --name clangen --windowed --noupx --onedir --clean --add-data "sprites;sprites" --add-data "resources;resources" --add-data "README.md;." main.py
        run: python -m PyInstaller Clangen.spec
      - name: Create archive (.zip)
        run: tar.exe -a -c -f Clangen_Win64.zip -C dist Clangen
      - uses: actions/upload-artifact@v3
        with:
          name: Clangen_Win64.zip
          path: Clangen_Win64.zip
      - name: Release 
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: Clangen_Win64.zip
          
  build_macos64:
    runs-on: macos-11
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python 3.11 x64
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: 'x64'
      - name: Update pip
        run: python -m pip install --upgrade pip
      - name: Update setuptools
        run: python -m pip install --upgrade setuptools
      - name: Install dependencies
        run: python -m pip install -r requirements.txt
      - name: Install Pillow for icon format conversion
        run: python -m pip install --upgrade Pillow
      - name: Install PyInstaller
        run: python -m pip install --upgrade PyInstaller
      - name: Run PyInstaller
        #run: python -m PyInstaller -i resources/images/icon.png --name clangen --windowed --onedir --clean --add-data sprites:sprites --add-data resources:resources --add-data README.md:. main.py
        run: python -m PyInstaller Clangen.spec
      - name: Create archive (.tar.xz)
        run: |
          rm -r dist/Clangen
      - name: Install appdmg
        run: "npm install -g appdmg"
      - name: Generate .dmg
        run: "appdmg appdmg.json Clangen_macOS64.dmg"
      - uses: actions/upload-artifact@v3
        with:
          name: Clangen_macOS64.dmg
          path: Clangen_macOS64.dmg
      - name: Release 
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: Clangen_macOS64.dmg
